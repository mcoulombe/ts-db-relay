services:
  setup:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ts-db-setup
    environment:
      - TS_CONTROL_URL=http://localhost:31544
      - TS_LOCAL_STORAGE_DIR=./data/ts-state
      - TS_ADMIN_PORT=8080
    volumes:
      - ..:/workspace
    stdin_open: true
    tty: true

  postgres:
    image: postgres:15
    container_name: ts-db-postgres
    entrypoint: ["/entrypoint-postgres.sh"]
    environment:
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=Test4Sk8board
      - POSTGRES_DB=testdb
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
      - ../data/postgres-certs:/var/lib/postgres-certs
      - ../data:/workspace/data
      - ./entrypoint-postgres.sh:/entrypoint-postgres.sh:ro
    ports:
      - "5432:5432"
    depends_on:
      setup:
        condition: service_started

  cockroachdb:
    image: cockroachdb/cockroach:latest
    container_name: ts-db-cockroachdb
    entrypoint: ["/entrypoint-cockroachdb.sh"]
    environment:
      - COCKROACH_USER=test
      - COCKROACH_PASSWORD=Test4Sk8board
      - COCKROACH_DB=testdb
    volumes:
      - ../data/cockroachdb:/cockroach/cockroach-data
      - ../data/cockroachdb-certs:/var/lib/cockroachdb-certs
      - ../data:/workspace/data
      - ./entrypoint-cockroachdb.sh:/entrypoint-cockroachdb.sh:ro
    ports:
      - "26257:26257"
    depends_on:
      setup:
        condition: service_started

  mongodb:
    image: mongo:7.0
    container_name: ts-db-mongodb
    entrypoint: ["/entrypoint-mongodb.sh"]
    environment:
      - MONGODB_USER=test
      - MONGODB_PASSWORD=Test4Sk8board
      - MONGODB_DB=testdb
    volumes:
      - ../data/mongodb:/data/db
      - ../data/mongodb-certs:/etc/ssl/mongodb
      - ../data:/workspace/data
      - ./entrypoint-mongodb.sh:/entrypoint-mongodb.sh:ro
    ports:
      - "27017:27017"
    sysctls:
      - net.core.somaxconn=4096
    depends_on:
      setup:
        condition: service_started
